name: ðŸ¤– AI Review (Unified Free Code Review)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install linters
        run: |
          pip install flake8 bandit codespell
          sudo apt-get update
          sudo apt-get install -y yamllint shellcheck

      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Install hadolint
        run: |
          wget -O /usr/local/bin/hadolint \
            https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint


      # --------------------------------------------------
      # Unified flake8
      # --------------------------------------------------
      - name: flake8 review
        run: |
          flake8 . \
            | sed 's/: /:1: /' \
            | reviewdog -efm="%f:%l:%c: %m" -name="flake8" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # --------------------------------------------------
      # Unified bandit
      # --------------------------------------------------
      - name: bandit review
        run: |
          bandit -r . -f txt \
            | sed -E 's/^(.+):([0-9]+) (.+)$/\1:\2:1: \3/' \
            | reviewdog -efm="%f:%l:%c: %m" -name="bandit" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # --------------------------------------------------
      # Unified hadolint
      # --------------------------------------------------
      - name: hadolint review
        run: |
          files=$(git ls-files '*Dockerfile' 'Dockerfile' 'app/Dockerfile' || true)
          if [ -z "$files" ]; then exit 0; fi

          hadolint $files \
            | sed -E 's/^(.+):([0-9]+):([0-9]+): (.+)$/\1:\2:\3: \4/' \
            | reviewdog -efm="%f:%l:%c: %m" -name="hadolint" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # --------------------------------------------------
      # Unified shellcheck
      # --------------------------------------------------
      - name: shellcheck review
        run: |
          files=$(git ls-files '*.sh' || true)
          if [ -z "$files" ]; then exit 0; fi

          shellcheck -f gcc $files \
            | sed -E 's/^(.+):([0-9]+):([0-9]+): (.+)$/\1:\2:\3: \4/' \
            | reviewdog -efm="%f:%l:%c: %m" -name="shellcheck" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}



      # --------------------------------------------------
      # Unified yamllint
      # --------------------------------------------------
      - name: yamllint review
        run: |
          yamllint -f parsable . \
            | sed -E 's/^(.+):([0-9]+):([0-9]+): \[(.+)\] (.+)$/\1:\2:\3: \4 - \5/' \
            | reviewdog -efm="%f:%l:%c: %m" -name="yamllint" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # --------------------------------------------------
      # Unified codespell
      # --------------------------------------------------
      - name: codespell review
        run: |
          codespell . \
            | sed -E 's/^(.*):([0-9]+): (.*)$/\1:\2:1: \3/' \
            | reviewdog -efm="%f:%l:%c: %m" -name="codespell" -reporter=github-pr-review -fail-on-error=false
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
